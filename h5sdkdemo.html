<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>h5sdk config demo</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script
      type="text/javascript"
      src="https://lf1-cdn-tos.bytegoofy.com/goofy/lark/op/h5-js-sdk-1.5.16.js"
    ></script>
    <script src="https://unpkg.com/vconsole/dist/vconsole.min.js"></script>
    <script src='https://lf-package-cn.feishucdn.com/obj/feishu-static/op/fe/devtools_frontend/remote-debug-0.0.1-alpha.6.js'></script>
    <script>
        var vConsole = new window.VConsole();
    </script>
</head>
<body>
Token: <input id="token"/> <button onclick="apiAuth()">Auth</button>

<div class="img" style="display: none;">
    <!-- 头像 -->
    <div id="img_div" class="img_div"></div>
    <span class="text_hello">Hello</span>
    <!-- 名称 -->
    <div id="hello_text_name" class="text_hello_name"></div>
    <!-- 欢迎语 -->
    <div id="hello_text_welcome" class="text_hello_welcome"></div>
    <button onclick="camera()">拍照</button>
</div>


</body>
<script>
    let lang = window.navigator.language;

    function showUser(res) {
        $("#img_div").html(
            `<img src="${res.avatarUrl}" width="100px" height="100px"/>`
        );

        $("#hello_text_name").text(
            lang === "zh_CN" || lang === "zh-CN"
                ? `${res.nickName}`
                : `${res.i18nName.en_us}`
        );

        $("#hello_text_welcome").text(
            lang === "zh_CN" || lang === "zh-CN" ? "欢迎使用飞书" : "welcome to Feishu"
        );

        $("#img_div").show();
    }
    function camera() {
      tt.chooseImage({
          sourceType: ['camera'],
          count: 2,
          sizeType:["original","compressed"],
          // cameraDevice: 'front',
          isSaveToAlbum: '0',
          success (res) {
            console.log(res.tempFilePaths, res.tempFiles);
          },
          fail (res) {
            console.log(`chooseImage 调用失败`);
          }
      });
    }
    
    function apiAuth() {
        console.log("start apiAuth");
        if (!window.h5sdk) {
            console.log("invalid h5sdk");
            alert("please open in feishu");
            return;
        }

        // 调用config接口的当前网页url
        const url = location.href.split("#")[0];
        console.log("接入方前端将需要鉴权的url发给接入方服务端,url为:", url);
        const token = $('#token').val();
        // 向接入方服务端发起请求，获取鉴权参数（appId、timestamp、nonceStr、signature）
        // 使用 fetch 获取 config 参数
        fetch("https://open.feishu.cn/anycross/trigger/callback/MGMyMDkxMmQ3MWIyZmI5ZmZhMTFjZTE5YmY4YTM3ZDA0", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url, token })
        })
            .then(res => res.json())
            .then(res => {
                console.log(
                    "接入方服务端返回给接入方前端的结果(前端调用config接口的所需参数):", res
                );
                console.log(window.h5sdk.config);
                // 通过error接口处理API验证失败后的回调
                window.h5sdk.error((err) => {
                    throw ("h5sdk error:", JSON.stringify(err));
                });
                // 调用config接口进行鉴权
                window.h5sdk.config({
                    appId: res.appid,
                    timestamp: res.timestamp,
                    nonceStr: res.noncestr,
                    signature: res.signature,
                    jsApiList: ["scope.userInfo"],
                    //鉴权成功回调
                    onSuccess: (res) => {
                        console.log(`config success: ${JSON.stringify(res)}`);
                    },
                    //鉴权失败回调
                    onFail: (err) => {
                        console.error(`config failed: ${JSON.stringify(err)}`);
                    },
                });

                // 完成鉴权后，便可在 window.h5sdk.ready 里调用 JSAPI
                window.h5sdk.ready(() => {
                    // window.h5sdk.ready回调函数在环境准备就绪时触发
                    // 调用 getUserInfo API 获取已登录用户的基本信息，详细文档参见https://open.feishu.cn/document/uYjL24iN/ucjMx4yNyEjL3ITM
                    tt.getUserInfo({
                        // getUserInfo API 调用成功回调
                        success(res) {
                            console.log(`getUserInfo success: ${JSON.stringify(res)}`);
                            // 单独定义的函数showUser，用于将用户信息展示在前端页面上
                            showUser(res.userInfo);
                        },
                        // getUserInfo API 调用失败回调
                        fail(err) {
                            console.log(`getUserInfo failed:`, JSON.stringify(err));
                        },
                    });
                    // 调用 showToast API 弹出全局提示框，详细文档参见https://open.feishu.cn/document/uAjLw4CM/uYjL24iN/block/api/showtoast
                    tt.showToast({
                        title: "鉴权成功",
                        icon: "success",
                        duration: 3000,
                        success(res) {
                            console.log("showToast 调用成功", res.errMsg);
                        },
                        fail(res) {
                            console.log("showToast 调用失败", res.errMsg);
                        },
                        complete(res) {
                            console.log("showToast 调用结束", res.errMsg);
                        },
                    });
                });
            })
            .catch(err => console.error("fetch error", err));

            
    }

</script>
</html>
